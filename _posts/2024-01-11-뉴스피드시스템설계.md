---
title: "대규모 뉴스 피드 시스템 설계"
excerpt: "페이스북, 인스타그램과 같은 피드 시스템을 설계해보자"

categories:
  - ETC

permalink: /ETC/news-feed-system-design/

toc: true
toc_sticky: true

date: 2024-01-11
last_modified_at: 2024-01-11
---

## 뉴스 피드 시스템 설계

'가상 면접 사례로 배우는 대규모 시스템 설계 기초'라는 책을 토대로, 현실적인 예제를 통해 대규모 시스템을 어떻게 설계하는지 살펴보도록 하겠습니다. 이 글에서는 특히 우리가 흔히 사용하는 소셜 미디어 플랫폼에서 핵심적인 기능 중 하나인 '뉴스 피드(news feed)' 시스템을 중심으로 다룰 것입니다. 페이스북, 인스타그램, 트위터와 같은 플랫폼에서는 뉴스 피드가 사용자에게 다양한 콘텐츠를 제공하는 핵심적인 역할을 합니다.

### 대규모 시스템 설계
뉴스 피드를 설계하기 전에 많은 사용자가 사용하는 서비스의 대략적인 아키텍처를 살펴보겠습니다.
![enter image description here](https://raw.githubusercontent.com/rineeee/rineeee.github.io/733f733893e81af2607cc6be07364521a673c0a9/assets/images/%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A81.png)

앞으로의 설계는 해당 stateless 설계를 바탕으로 진행합니다. 

1.  **정적 컨텐츠는 CDN 활용:** 
    -   이미지 및 정적 자원은 CDN을 통해 빠르게 전달합니다.
2.  **로드 밸런서를 활용한 서버 분산:** 
    -   사용자는 DNS를 통해 로드 밸런서의 IP에 연결되고, 로드 밸런서는 여러 서버에 트래픽을 분산합니다.
3.  **Stateless 아키텍처와 다중화된 서버, 데이터베이스:** 
    -   상태 정보는 NoSQL 데이터베이스에 저장하고, 서버와 데이터베이스는 다중화하여 고가용성 보장합니다.
4.  **메시지 큐로 느슨한 결합:** 
    -   서비스 간의 통신은 메시지 큐를 활용하여 느슨한 결합 구현합니다.
5.  **캐시를 활용한 데이터베이스 부하 감소:** 
    -   자주 사용되는 데이터를 캐시에 저장하여 응답 시간 최적화합니다.  
6.  **다중 데이터 센터 고려:** 
    -   필요 시 다중 데이터 센터를 활용하여 고가용성 및 재해 복구 기능 향상합니다.

### 뉴스 피드 설계
#### 조건
1. 웹/앱 둘 다 지원
2. 최소 기능: 피드 발행(이미지, 동영상 포함) / 뉴스 피드 생성(시간 흐름 역순)
3. 최대 친구 수: 5000명
4. DAU:  천만명

#### 1. 피드 발행
*POST /v1/me/feed*
![enter image description here](https://github.com/rineeee/rineeee.github.io/blob/main/assets/images/%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A82.png?raw=true)
1.  **사용자의 포스팅 작업:**  
    -   사용자가 새 포스팅을 올리면, 피드 발생 API를 사용하여 해당 포스팅을 등록합니다.
2.  **트래픽 분산 및 내부 서비스 연결:**
    -   로드 밸런서는 트래픽을 여러 웹 서버로 분산합니다.
    -   웹 서버는 받은 HTTP 요청을 내부 서비스로 중계하여 비즈니스 로직 수행합니다.
3.  **포스팅 저장 서비스:**
    -   새 포스팅은 데이터베이스와 캐시에 저장됩니다.
    -   안정 해시를 사용하여 요청과 데이터를 고르게 분산시켜 핫키 이슈를 완화합니다.
4.  **포스팅 전송 서비스:**
    -   새 포스팅은 포스팅 저장 후, 포스팅 전송 서비스가 해당 포스팅을 친구의 뉴스 피드에 푸시합니다.
    -   캐시를 활용하여 빠르게 읽을 수 있도록 보관됩니다.
5.  **알림 서비스:**
    -   알림 서비스는 새 포스팅에 대한 알림을 친구들에게 전송합니다.
6.  **뉴스 피드 갱신:**
    -   사용자의 뉴스 피드를 가져오는 작업에는 Push 모델과 Pull 모델을 혼합하여 사용합니다.
    -   대부분의 사용자에게는 Push 모델을 적용하고, 유명인의 경우 Pull 모델을 사용하여 시스템 부하를 분산시킵니다.
7.  **안정 해시 및 메모리 관리:**
    -   안정 해시를 활용하여 요청과 데이터를 고르게 분산시키고 핫키 이슈를 해결합니다.
    -   캐시 크기를 제한하여 메모리 요구량을 고려하여 효율적인 메모리 관리를 수행합니다.
8.  **그래프 데이터베이스 활용:**
    -   친구 ID 목록을 그래프 데이터베이스에서 효율적으로 가져옵니다.
9.  **팬아웃 작업 서버:**
    -   메시지 큐에서 데이터를 가져와 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는 팬아웃 작업 서버를 도입합니다.


#### 2. 피트 읽기
*GET /v1/me/feed*

![enter image description here](https://github.com/rineeee/rineeee.github.io/blob/main/assets/images/%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A83.png?raw=true)
1.  **사용자가 피드 읽기 API를 호출:**  
    -   사용자가 앱 또는 웹에서 피드 읽기 API를 호출하여 최신 뉴스 피드를 요청합니다.
2.  **로드 밸런서로 트래픽 분산:**
    -   로드 밸런서는 트래픽을 여러 웹 서버로 분산하여 효율적으로 부하를 분산합니다.
3.  **웹 서버에서 뉴스 피드 서비스 호출:**
    -   웹 서버는 받은 트래픽을 뉴스 피드 서비스로 중계하여 사용자의 뉴스 피드를 가져오는 요청을 시작합니다.
4.  **뉴스 피드 서비스에서 포스팅 ID 목록 및 정보 가져오기:**
    -   뉴스 피드 서비스는 캐시에서 포스팅 ID 목록을 가져오고, 각 포스팅에 필요한 정보를 렌더링하기 위해 데이터를 가져옵니다.
5.  **뉴스 피드 JSON 형태로 클라이언트에 전송:**
    -   가져온 정보를 이용하여 생성된 뉴스 피드를 JSON 형태로 클라이언트에 전송합니다.
6.  **클라이언트에서 뉴스 피드 렌더링:**
    -   클라이언트는 전송받은 JSON 데이터를 이용하여 뉴스 피드를 렌더링합니다.

#### 캐시 구조
![enter image description here](https://github.com/rineeee/rineeee.github.io/blob/main/assets/images/%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A84.png?raw=true)